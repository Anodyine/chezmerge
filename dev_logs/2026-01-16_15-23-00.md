# Dev Log: Architecture Shift to Git Submodules

**Date:** 2026-01-16 15:23 EST
**Author:** Architect & Editor Pair

## üîÑ Architecture Change: Persistent State via Submodules

We identified a critical flaw in the previous "ephemeral workspace" design. To perform a 3-way merge effectively over time, we need to persist the "Base" state (the last known upstream commit we synced with). Without this, we cannot distinguish between "upstream didn't change this file" and "upstream changed it back to an old state," nor can we accurately detect our own local changes against the correct ancestor.

### The Solution: Git Submodules

We have replaced the `.merge_workspace` directory with a standard Git Submodule located at `.chezmerge-upstream`.

**Benefits:**
1.  **Native State Tracking:** Git tracks the submodule commit hash automatically. This *is* our "Base" state.
2.  **Versioning:** The upstream version is now versioned alongside the user's dotfiles. Rolling back the dotfiles repo also rolls back the upstream dependency state.
3.  **Transparency:** The dependency is visible to the user, not hidden in a temp folder.

## üõ† Implementation Details

### 1. Git Operations (`src/chezmerge/git_ops.py`)
*   Replaced `git clone` logic with `git submodule add`.
*   Added `protocol.file.allow = always` configuration to support local E2E tests (which use file paths as remotes).
*   Added `stage_file` and `commit` methods to `GitHandler`.
*   `update_base_pointer` now checks out the new upstream commit in the submodule and stages the submodule folder in the parent repo.

### 2. Workflow Automation (`src/chezmerge/main.py`)
*   **Auto-Staging:** As files are merged (automatically or via UI), they are immediately staged (`git add`).
*   **Auto-Commit:** Upon successful completion of a merge run, the tool now automatically commits the changes with a standard message: `chore(chezmerge): Merge upstream changes`. This ensures the new submodule pointer is saved immediately.

### 3. Testing
*   Updated `tests/e2e/test_e2e_auto_merge.sh` and others to accommodate the submodule initialization process.
*   Fixed `fatal: transport 'file' not allowed` errors in tests by passing configuration flags during submodule initialization.

## üìù Next Steps
*   Verify the TUI interaction with the new backend manually.
*   Ensure `chezmoi apply` works seamlessly with the resulting file structure.
