# Dev Log: 2026-01-15

## Overview
Today we significantly enhanced `chezmerge` by implementing "Smart Merge" capabilities. The tool can now automatically resolve safe updates and non-overlapping conflicts without user intervention, falling back to the UI only when necessary. We also established a comprehensive End-to-End (E2E) regression suite to guarantee stability.

## Core Logic Changes

### 1. Automatic Merge Strategies
We introduced two automatic merge paths in `src/chezmerge/main.py` to bypass the UI:

*   **Fast-Forward (`AUTO_UPDATE`)**:
    *   **Logic**: Occurs when `Base == Ours` and `Theirs != Base`.
    *   **Action**: The local file is simply overwritten with the upstream version.
*   **3-Way Auto-Merge (`AUTO_MERGEABLE`)**:
    *   **Logic**: Occurs when `Base != Ours` and `Base != Theirs` (Conflict), but changes are non-overlapping.
    *   **Implementation**: Added `MergeScenario.AUTO_MERGEABLE` to `src/chezmerge/logic.py`.
    *   **Action**: We implemented `GitHandler.attempt_merge` in `src/chezmerge/git_ops.py` which utilizes `git merge-file` with temporary files to resolve these conflicts automatically.

### 2. Critical Fixes & Refinements
*   **Whitespace Handling**: Modified `GitHandler.run_git` to accept a `strip` argument and updated `get_file_content` to use `strip=False`. This was critical because `git show` output was being stripped of trailing newlines, causing false positives when comparing against local file content (which retained newlines).
*   **Template Detection**: Updated `main.py` to explicitly check for `.tmpl` extensions. We now force `is_template=True` in the `FileState` for these files, ensuring they are excluded from raw auto-merging logic (which could corrupt template syntax).
*   **Dry Run Safety**: Ensured the "All changes merged automatically" block respects the `--dry-run` flag and does not update the git base pointer during a simulation.

## Testing Infrastructure (`tests/e2e/`)

We created a robust suite of Bash scripts to verify end-to-end workflows:

1.  **`test_e2e_workflow.sh`**: Validates basic initialization and manual conflict detection.
2.  **`test_e2e_fast_forward.sh`**: Verifies that upstream changes are automatically applied when the local file is untouched.
3.  **`test_e2e_local_changes_only.sh`**: Verifies that local changes are preserved (and ignored by the merger) when upstream has not changed.
4.  **`test_e2e_mixed_states.sh`**: Tests 4 simultaneous files (Synced, Local-Only, Remote-Only, and Conflict) to ensure correct classification.
    *   *Fix*: Updated test setup to use dotfiles upstream (e.g., `.f_synced`) so they correctly map to `dot_` prefixes locally.
5.  **`test_e2e_auto_merge.sh`**: Verifies that `git merge-file` correctly merges non-overlapping changes (e.g., line 1 changed upstream, line 10 changed locally).

### Runner
*   Added `tests/run_all.sh` to execute the entire suite and report pass/fail status.

## Files Modified
*   `src/chezmerge/main.py`
*   `src/chezmerge/logic.py`
*   `src/chezmerge/git_ops.py`
*   `src/chezmerge/importer.py`
*   `tests/e2e/*.sh`
*   `tests/run_all.sh`
